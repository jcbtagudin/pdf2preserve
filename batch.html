<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF2Preserve - Batch Conversion</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 24px;
      margin: 0;
    }
    
    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      font-size: 14px;
    }
    
    .btn:hover {
      background: rgba(255,255,255,0.3);
      color: white;
      text-decoration: none;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    .tier-indicator {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .tier-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .tier-badge {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }
    
    .tier-badge.pro {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #8B4513;
    }
    
    .credits {
      text-align: center;
    }
    
    .credits-count {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .credits-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .upgrade-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s;
      border: none;
      cursor: pointer;
    }
    
    .upgrade-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
      color: white;
      text-decoration: none;
    }
    
    .batch-section {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .section-title {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .upload-zone {
      border: 3px dashed #ccc;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s;
      background: #fafafa;
      margin-bottom: 20px;
    }
    
    .upload-zone.dragover {
      border-color: #007bff;
      background: #f0f8ff;
    }
    
    .upload-zone input[type="file"] {
      display: none;
    }
    
    .upload-icon {
      font-size: 48px;
      color: #ccc;
      margin-bottom: 15px;
    }
    
    .upload-text {
      font-size: 18px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .upload-subtext {
      font-size: 14px;
      color: #999;
    }
    
    .file-list {
      margin-top: 20px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      background: white;
    }
    
    .file-info {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }
    
    .file-icon {
      font-size: 24px;
      color: #e74c3c;
    }
    
    .file-details {
      flex: 1;
    }
    
    .file-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .file-size {
      font-size: 12px;
      color: #666;
    }
    
    .file-status {
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-processing {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .status-completed {
      background: #d4edda;
      color: #155724;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .remove-file {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .conversion-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .option-group {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .option-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    
    .format-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .format-option {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }
    
    .format-option:hover {
      border-color: #007bff;
      background: #f0f8ff;
    }
    
    .format-option input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .process-btn {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s;
    }
    
    .process-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }
    
    .process-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .progress-section {
      display: none;
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      transition: width 0.5s ease;
      width: 0%;
    }
    
    .download-section {
      display: none;
      text-align: center;
      padding: 30px;
      border: 2px dashed #28a745;
      border-radius: 10px;
      background: #f8fff8;
      margin-top: 30px;
    }
    
    .download-btn {
      background: #28a745;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin: 10px;
    }
    
    .download-btn:hover {
      background: #1e7e34;
      color: white;
      text-decoration: none;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .tier-indicator {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .conversion-options {
        grid-template-columns: 1fr;
      }
      
      .format-grid {
        grid-template-columns: 1fr;
      }
      
      .header-controls {
        flex-wrap: wrap;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîÅ Batch Conversion Tool</h1>
    <div class="header-controls">
      <a href="/" class="btn">‚Üê Back to Home</a>
      <a href="/viewer" class="btn">üß† Viewer</a>
    </div>
  </div>
  
  <div class="container">
    <div class="tier-indicator">
      <div class="tier-info">
        <div class="tier-badge" id="tierBadge">FREE TIER</div>
        <div>
          <h3>Batch PDF Conversion</h3>
          <p style="color: #666; margin: 0;">Convert multiple PDFs at once with bulk download</p>
        </div>
      </div>
      
      <div style="display: flex; gap: 20px; align-items: center;">
        <div class="credits">
          <div class="credits-count" id="creditsCount">3</div>
          <div class="credits-label">files remaining today</div>
        </div>
        <button class="upgrade-btn" onclick="showUpgradeModal()">
          ‚ú® Upgrade to Pro
        </button>
      </div>
    </div>
    
    <div class="batch-section">
      <h2 class="section-title">üìÅ Upload Multiple PDFs</h2>
      
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">üìÑ</div>
        <div class="upload-text">Drop PDF files here or click to browse</div>
        <div class="upload-subtext">Free tier: up to 3 files per day | Pro: unlimited</div>
        <input type="file" id="fileInput" multiple accept="application/pdf">
      </div>
      
      <div class="file-list" id="fileList"></div>
    </div>
    
    <div class="batch-section">
      <h2 class="section-title">‚öôÔ∏è Conversion Settings</h2>
      
      <div class="conversion-options">
        <div class="option-group">
          <div class="option-title">üìê Text Structure</div>
          <div style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; margin-bottom: 10px;">
              <input type="radio" name="layoutMode" value="preserve" checked style="margin-right: 8px;">
              üéØ Preserve Visual Layout
            </label>
            <label style="display: flex; align-items: center;">
              <input type="radio" name="layoutMode" value="clean" style="margin-right: 8px;">
              üßπ Clean Text Only
            </label>
          </div>
        </div>
        
        <div class="option-group">
          <div class="option-title">üìÑ Export Formats</div>
          <div class="format-grid">
            <label class="format-option">
              <input type="checkbox" name="formats" value="txt" checked>
              Plain Text (.txt)
            </label>
            <label class="format-option">
              <input type="checkbox" name="formats" value="html">
              HTML (.html)
            </label>
            <label class="format-option">
              <input type="checkbox" name="formats" value="markdown">
              Markdown (.md)
            </label>
            <label class="format-option">
              <input type="checkbox" name="formats" value="docx">
              Word (.docx)
            </label>
          </div>
        </div>
      </div>
      
      <button class="process-btn" id="processBtn" onclick="startBatchProcessing()">
        üöÄ Start Batch Conversion
      </button>
    </div>
    
    <div class="progress-section" id="progressSection">
      <h2 class="section-title">‚è≥ Processing Files...</h2>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div id="progressText">Preparing files...</div>
    </div>
    
    <div class="download-section" id="downloadSection">
      <h2 class="section-title">‚úÖ Conversion Complete!</h2>
      <p>Your batch conversion is ready for download.</p>
      <a href="#" class="download-btn" id="downloadBtn">
        üì¶ Download ZIP Archive
      </a>
      <div style="margin-top: 15px; font-size: 14px; color: #666;">
        ZIP file contains all converted files organized by format
      </div>
    </div>
  </div>

  <!-- Upgrade Modal -->
  <div id="upgradeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px; border-radius: 15px; max-width: 500px; text-align: center;">
      <h2 style="color: #333; margin-bottom: 20px;">‚ú® Upgrade to Pro</h2>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
        <div style="text-align: center;">
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <h3 style="color: #666;">Free Tier</h3>
            <div style="font-size: 24px; color: #333; margin: 10px 0;">3 files/day</div>
            <ul style="list-style: none; padding: 0; color: #666; font-size: 14px;">
              <li>‚úÖ All formats</li>
              <li>‚úÖ Smart structuring</li>
              <li>‚è≥ Daily limit reset</li>
            </ul>
          </div>
        </div>
        
        <div style="text-align: center;">
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">
            <h3>Pro Tier</h3>
            <div style="font-size: 24px; margin: 10px 0;">Unlimited</div>
            <ul style="list-style: none; padding: 0; font-size: 14px;">
              <li>‚úÖ Unlimited files</li>
              <li>‚úÖ Batch processing</li>
              <li>‚úÖ Priority support</li>
              <li>‚úÖ Advanced features</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div style="margin: 30px 0;">
        <button style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px 30px; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 15px;">
          üöÄ Upgrade Now - $9/month
        </button>
        <button onclick="closeUpgradeModal()" style="background: #6c757d; color: white; padding: 15px 20px; border: none; border-radius: 25px; cursor: pointer;">
          Maybe Later
        </button>
      </div>
    </div>
  </div>

  <script>
    let uploadedFiles = [];
    let dailyCredits = 3;
    let isPro = false;
    
    // DOM elements
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const creditsCount = document.getElementById('creditsCount');
    const processBtn = document.getElementById('processBtn');
    const progressSection = document.getElementById('progressSection');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const downloadSection = document.getElementById('downloadSection');
    const downloadBtn = document.getElementById('downloadBtn');
    
    // Load credits from localStorage
    function loadCredits() {
      const today = new Date().toDateString();
      const stored = localStorage.getItem('pdf2preserve_credits');
      
      if (stored) {
        const data = JSON.parse(stored);
        if (data.date === today) {
          dailyCredits = data.credits;
        } else {
          // New day, reset credits
          dailyCredits = 3;
          localStorage.setItem('pdf2preserve_credits', JSON.stringify({
            date: today,
            credits: 3
          }));
        }
      } else {
        localStorage.setItem('pdf2preserve_credits', JSON.stringify({
          date: today,
          credits: 3
        }));
      }
      
      updateCreditsDisplay();
    }
    
    function updateCreditsDisplay() {
      creditsCount.textContent = dailyCredits;
      if (dailyCredits <= 0) {
        processBtn.disabled = true;
        processBtn.textContent = '‚ùå Daily limit reached - Upgrade to Pro';
      }
    }
    
    function useCredit() {
      if (isPro) return true;
      
      if (dailyCredits <= 0) return false;
      
      dailyCredits--;
      const today = new Date().toDateString();
      localStorage.setItem('pdf2preserve_credits', JSON.stringify({
        date: today,
        credits: dailyCredits
      }));
      
      updateCreditsDisplay();
      return true;
    }
    
    // File upload handling
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });
    
    function handleFiles(files) {
      for (let file of files) {
        if (file.type === 'application/pdf') {
          if (!isPro && uploadedFiles.length >= 3) {
            alert('Free tier limit: 3 files maximum. Upgrade to Pro for unlimited files.');
            break;
          }
          
          uploadedFiles.push({
            file: file,
            name: file.name,
            size: formatFileSize(file.size),
            status: 'pending',
            id: Date.now() + Math.random()
          });
        }
      }
      updateFileList();
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function updateFileList() {
      if (uploadedFiles.length === 0) {
        fileList.innerHTML = '';
        return;
      }
      
      fileList.innerHTML = uploadedFiles.map((fileInfo, index) => `
        <div class="file-item">
          <div class="file-info">
            <div class="file-icon">üìÑ</div>
            <div class="file-details">
              <div class="file-name">${fileInfo.name}</div>
              <div class="file-size">${fileInfo.size}</div>
            </div>
          </div>
          <div class="file-status status-${fileInfo.status}">
            ${fileInfo.status.toUpperCase()}
          </div>
          <button class="remove-file" onclick="removeFile(${index})" title="Remove file">√ó</button>
        </div>
      `).join('');
    }
    
    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      updateFileList();
    }
    
    async function startBatchProcessing() {
      if (uploadedFiles.length === 0) {
        alert('Please upload at least one PDF file.');
        return;
      }
      
      if (!isPro && uploadedFiles.length > dailyCredits) {
        alert(`Free tier limit: ${dailyCredits} files remaining today. Upgrade to Pro for unlimited processing.`);
        return;
      }
      
      // Get selected formats
      const formatCheckboxes = document.querySelectorAll('input[name="formats"]:checked');
      if (formatCheckboxes.length === 0) {
        alert('Please select at least one export format.');
        return;
      }
      
      const formats = Array.from(formatCheckboxes).map(cb => cb.value);
      const layoutMode = document.querySelector('input[name="layoutMode"]:checked').value;
      
      // Show progress section
      progressSection.style.display = 'block';
      processBtn.disabled = true;
      
      try {
        const formData = new FormData();
        
        uploadedFiles.forEach((fileInfo, index) => {
          formData.append('pdf_files', fileInfo.file);
        });
        
        formData.append('formats', JSON.stringify(formats));
        formData.append('layout_mode', layoutMode);
        
        // Start processing
        const response = await fetch('/batch-convert', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('Batch conversion failed');
        }
        
        // Simulate progress updates
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 20;
          if (progress >= 90) {
            clearInterval(progressInterval);
            progress = 90;
          }
          
          progressFill.style.width = progress + '%';
          progressText.textContent = `Processing files... ${Math.round(progress)}%`;
        }, 500);
        
        const blob = await response.blob();
        
        // Complete progress
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        progressText.textContent = 'Conversion complete!';
        
        // Use credits for non-pro users
        if (!isPro) {
          for (let i = 0; i < uploadedFiles.length; i++) {
            useCredit();
          }
        }
        
        // Show download section
        setTimeout(() => {
          progressSection.style.display = 'none';
          downloadSection.style.display = 'block';
          
          // Create download link
          const url = window.URL.createObjectURL(blob);
          downloadBtn.href = url;
          downloadBtn.download = `batch_conversion_${Date.now()}.zip`;
        }, 1000);
        
      } catch (error) {
        console.error('Batch processing error:', error);
        alert('Error during batch processing. Please try again.');
        progressSection.style.display = 'none';
        processBtn.disabled = false;
      }
    }
    
    function showUpgradeModal() {
      document.getElementById('upgradeModal').style.display = 'flex';
    }
    
    function closeUpgradeModal() {
      document.getElementById('upgradeModal').style.display = 'none';
    }
    
    // Initialize
    loadCredits();
  </script>
</body>
</html>